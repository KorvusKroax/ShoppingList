# nginx/default.conf - Végleges Symfony/Nginx Konfiguráció

map $request_method $cors_bypass {
    OPTIONS 1;
    default 0;
}

server {
    listen 80;
    server_name localhost;
    # A projekt root mappája a konténerben, amire a Docker Compose rámutat:
    root /var/www/html/public;

    # --- CORS HEADEREK DEFINIÁLÁSA ---
    add_header 'Access-Control-Allow-Origin' 'http://localhost:3000' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, Origin, Accept, X-Requested-With' always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;
    add_header 'Access-Control-Max-Age' '3600' always;

    # 1. CORS Preflight Kezelése
    if ($cors_bypass) {
        return 204;
    }

    # 2. Statikus fájlok kiszolgálása (pl. public/index.html, CSS, JS)
    location / {
        try_files $uri /index.php$is_args$args;
    }

    # 3. Minden PHP/API kérés (beleértve az /api/login_check-et is)
    location ~ ^/index\.php(/|$) {
        fastcgi_pass backend:9000;
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        include fastcgi_params;

        # A legfontosabb: A FastCGI paraméterek a Symfony public/index.php fájljára mutatnak
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $realpath_root;

        internal;
    }
}
